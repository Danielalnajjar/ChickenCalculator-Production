# Deployment Guide

## Railway Platform Details

### Service IDs (for MCP Commands)
```bash
Project ID: 767deec0-30ac-4238-a57b-305f5470b318
Service ID: fde8974b-10a3-4b70-b5f1-73c4c5cebbbe
Environment ID: f57580c2-24dc-4c4e-adf2-313399c855a9
Postgres ID: bbbadbce-026c-44f1-974c-00d5a457bccf
```

### Deployment Configuration
- **Platform**: Railway
- **Auto-Deploy**: Enabled from main branch
- **Port**: 8080 (single-port constraint)
- **Database**: PostgreSQL 16.8
- **GitHub**: https://github.com/Danielalnajjar/ChickenCalculator-Production

## Environment Variables

### Required (Production)
```bash
JWT_SECRET=<32+ character secret>         # JWT signing key (min 32 chars)
ADMIN_DEFAULT_PASSWORD=<secure-password>  # Initial admin password
SENTRY_DSN=<configured>                  # Error tracking
DATABASE_URL=postgresql://...            # Railway provides automatically
SPRING_PROFILES_ACTIVE=production        # Production profile
```

### Database (Railway Auto-Provided)
```bash
PGUSER=postgres
PGPASSWORD=<auto-generated>
PGHOST=<hostname>
PGPORT=<port>
PGDATABASE=railway
```

### Optional Configuration
```bash
# Hibernate
DDL_AUTO=validate                        # Use 'validate' in production
DATABASE_PLATFORM=org.hibernate.dialect.PostgreSQLDialect

# Security
JWT_COOKIE_SAMESITE=Strict              # Cookie SameSite policy

# Connection Pool
DB_POOL_SIZE=15                         # Max connection pool size
DB_MIN_IDLE=5                           # Minimum idle connections
DB_CONNECTION_TIMEOUT=30000             # Connection timeout in ms
DB_IDLE_TIMEOUT=600000                  # Idle timeout in ms
DB_MAX_LIFETIME=1800000                 # Max connection lifetime
DB_LEAK_DETECTION=60000                 # Leak detection threshold

# Logging
FILTER_LOG_LEVEL=INFO                   # Diagnostic filter logging
INTERCEPTOR_LOG_LEVEL=INFO              # Request interceptor logging
EXCEPTION_LOG_LEVEL=INFO               # Exception handler logging
SQL_LOG_LEVEL=INFO                      # Hibernate SQL logging
SENTRY_LOG_LEVEL=INFO                   # Sentry integration logging
```

## Deployment Process

### Pre-Deployment Checklist
1. **Verify Compilation**
   ```bash
   cd backend
   mvn clean compile
   mvn test-compile
   ```

2. **Build Frontends**
   ```bash
   cd admin-portal && npm run build
   cd ../frontend && npm run build
   ```

3. **Check Sentry** for existing production errors

4. **Generate Secrets** (if needed)
   ```bash
   # JWT Secret (minimum 32 characters)
   openssl rand -base64 48
   
   # Admin Password (complex requirements)
   # Must contain: uppercase, lowercase, numbers
   ```

### Deploy to Production
```bash
git add .
git commit -m "feat: your changes"
git push origin main  # Auto-deploys to Railway
```

### Post-Deployment Verification

1. **Health Checks**
   - `/api/health` returns UP
   - `/actuator/health` shows components
   - Database connection verified

2. **Security**
   - Admin login works
   - Password change enforced on first login
   - JWT in httpOnly cookies
   - CSRF tokens working

3. **Monitoring**
   - Check Sentry for new errors
   - `/actuator/prometheus` accessible
   - Correlation IDs in headers

4. **Functionality**
   - Create test location
   - Access location via slug
   - Verify data isolation
   - Test calculator functions

## Rollback Procedure

### Via Railway Dashboard
1. Navigate to deployments
2. Select previous successful deployment
3. Click "Redeploy"

### Via Git
```bash
git revert HEAD
git push origin main
```

## Database Migrations

### Current Migration Status
- V1: Initial schema
- V2: Indexes and constraints
- V3: PostgreSQL sequences
- V4: Admin password reset
- V5: Location authentication

### Adding New Migrations
1. Create file in `backend/src/main/resources/db/migration/`
2. Name format: `V{number}__{description}.sql`
3. Test locally first
4. Deploy (Flyway runs automatically)

## Monitoring

### Key Metrics to Watch
- Error rate < 0.1%
- Response time p95 < 200ms
- Database pool usage < 50%
- Memory usage < 512MB

### Alert Channels
- Sentry: Real-time error notifications
- Railway: Deployment status
- Prometheus: Performance metrics